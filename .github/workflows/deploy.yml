name: Deploy

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm audit
      - run: npm test

  preview:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: Run migrations (preview)
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler d1 migrations apply learn-mandarin --remote --preview
      - name: Deploy to preview
        id: deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          OUTPUT=$(npx wrangler pages deploy dist --project-name=learn-mandarin --branch=preview 2>&1 | sed 's/\x1b\[[0-9;]*m//g')
          echo "$OUTPUT"
          URL=$(echo "$OUTPUT" | grep -oE 'https://[^ ]+\.pages\.dev' | head -1)
          if [ -z "$URL" ]; then
            echo "::error::Failed to extract preview URL from wrangler output"
            exit 1
          fi
          echo "url=$URL" >> "$GITHUB_OUTPUT"

  smoke-test:
    needs: preview
    runs-on: ubuntu-latest
    steps:
      - name: Smoke test preview
        run: |
          URL="${{ needs.preview.outputs.url }}"
          echo "Testing preview at $URL"
          sleep 5
          curl -sf --retry 3 --retry-delay 5 "$URL/"
          curl -sf --retry 3 --retry-delay 5 "$URL/content/articles/index.json"
          curl -sf --retry 3 --retry-delay 5 "$URL/api/cards?due=true"

  production:
    needs: smoke-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: Run migrations (production)
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler d1 migrations apply learn-mandarin --remote
      - name: Deploy to production
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: npx wrangler pages deploy dist --project-name=learn-mandarin --branch=main
